import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import rateLimit from 'express-rate-limit';
import swaggerUi from 'swagger-ui-express';
import swaggerJsdoc from 'swagger-jsdoc';
import { PrismaClient } from '@prisma/client';
import { logger } from './utils/logger';

// Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ñ€Ğ¾ÑƒÑ‚Ğ¾Ğ²
import { authRouter } from '@/routes/auth';
import { formsRouter } from '@/routes/forms';
import { usersRouter } from '@/routes/users';
import { consultationsRouter } from '@/routes/consultations';

const app = express();
const prisma = new PrismaClient();
const PORT = process.env.PORT || 3001;

// Trust proxy Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ rate limiting
app.set('trust proxy', true);

// Middleware
app.use(helmet());
app.use(cors({
  origin: [
    process.env.CLIENT_URL || 'http://localhost:3000',
    'http://localhost:3000',
    'https://*.railway.app' // Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ°ĞµĞ¼ Ğ²ÑĞµ Railway Ğ´Ğ¾Ğ¼ĞµĞ½Ñ‹
  ],
  credentials: true
}));

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  max: 100, // Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 100 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ IP
  message: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ IP, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.'
});
app.use(limiter);

// Ğ‘Ğ¾Ğ»ĞµĞµ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  max: 10, // Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 10 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ²Ñ…Ğ¾Ğ´Ğ°
  message: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ²Ñ…Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ.'
});

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// Swagger Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°
const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'Medical Aggregator API',
      version: '1.0.0',
      description: 'API Ğ´Ğ»Ñ Ğ¼ĞµĞ´Ğ¸Ñ†Ğ¸Ğ½ÑĞºĞ¾Ğ³Ğ¾ Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€Ğ° Ñ Ğ˜Ğ˜-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ¼',
    },
    servers: [
      {
        url: `http://localhost:${PORT}`,
        description: 'Development server',
      },
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
        },
      },
    },
  },
  apis: ['./src/routes/*.ts'],
};

const swaggerSpec = swaggerJsdoc(swaggerOptions);

// Ğ Ğ¾ÑƒÑ‚Ñ‹
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec));

// ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸
app.use('/api/auth', authLimiter, authRouter);
app.use('/api/forms', formsRouter);
app.use('/api/users', usersRouter);
app.use('/api/consultations', consultationsRouter);

// Health check
app.get('/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    environment: process.env.NODE_ENV
  });
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° 404
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    message: 'Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½'
  });
});

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
app.use((err: any, req: express.Request, res: express.Response, next: express.NextFunction) => {
  logger.error('ĞĞµĞ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°:', err);
  
  res.status(err.status || 500).json({
    success: false,
    message: process.env.NODE_ENV === 'production' 
      ? 'Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°' 
      : err.message,
    ...(process.env.NODE_ENV !== 'production' && { stack: err.stack })
  });
});

// Graceful shutdown
process.on('SIGTERM', async () => {
  logger.info('SIGTERM Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½, Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€...');
  await prisma.$disconnect();
  process.exit(0);
});

process.on('SIGINT', async () => {
  logger.info('SIGINT Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½, Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€...');
  await prisma.$disconnect();
  process.exit(0);
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.listen(PORT, () => {
  logger.info(`ğŸš€ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ ${PORT}`);
  logger.info(`ğŸ“š API Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ: http://localhost:${PORT}/api-docs`);
  logger.info(`ğŸ¥ Health check: http://localhost:${PORT}/health`);
});

export default app; 